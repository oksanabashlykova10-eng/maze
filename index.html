<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maze Trap: All-in-One (Editor & Game)</title>
    <link href="https://fonts.googleapis.com/css2?family=Metamorphous&family=Orbitron:wght@700&family=Caveat:wght@700&family=Cinzel:wght@700&family=Macondo&family=Montserrat:wght@800&family=Comic+Neue:wght@700&family=Pacifico&display=swap" rel="stylesheet">
    <style id="dynamic-styles">
        /* –°—Ç–∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∏ –æ–±—â–∏–µ —Å—Ç–∏–ª–∏ –∏–≥—Ä—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å */
        :root { --ui-color: #39ff14; --q-color: #ffe600; --prog-color: #00ff66; --game-font: 'Metamorphous', serif; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: #ddd; font-family: sans-serif; overflow: hidden; }
        
        /* –°–¢–ò–õ–ò –†–ï–î–ê–ö–¢–û–†–ê */
        #editor-ui { display: flex; flex-direction: column; height: 100vh; overflow-y: auto; background: #1a1a1a; pointer-events: auto; }
        header { display: flex; align-items: center; justify-content: space-between; padding: 15px 30px; background: #000; border-bottom: 2px solid var(--ui-color); box-shadow: 0 0 15px var(--ui-color); }
        .tab-btn { background: #222; border: 1px solid #444; color: #aaa; padding: 10px 15px; cursor: pointer; border-radius: 5px 5px 0 0; font-family: 'Metamorphous', serif; margin-right: 5px; }
        .tab-btn.active { background: #1a1a1a; color: #ffe600; border-color: #ffe600; border-bottom: none; }
        main { padding: 30px; flex-grow: 1; }
        .tab-content { display: none; max-width: 1100px; margin: 0 auto; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 15px; background: #222; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        label { display: block; margin-bottom: 8px; color: #fff; font-weight: bold; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 10px; background: #000; color: #fff; border: 1px solid #555; border-radius: 5px; box-sizing: border-box; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .btn-main { background: transparent; border: 2px solid var(--ui-color); color: var(--ui-color); padding: 12px 25px; border-radius: 30px; cursor: pointer; font-family: 'Metamorphous', serif; font-weight: bold; }
        
        /* –ü–†–ï–î–ü–†–û–°–ú–û–¢–† –í –†–ï–î–ê–ö–¢–û–†–ï */
        .preview-card { background: rgba(15, 5, 25, 0.95); border: 2px solid var(--ui-color); border-radius: 20px; padding: 30px; text-align: center; width: 85%; max-width: 400px; box-sizing: border-box; }
        .ans-btn-preview { width: 100%; padding: 15px; margin: 10px 0; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; color: #fff; box-sizing: border-box; text-align: center; }

        /* –°–¢–ò–õ–ò –ò–ì–†–´ */
        #game-ui { display: none; position: relative; width: 100%; height: 100vh; overflow: hidden; }
        #game-container { width: 100%; height: 100%; background-size: 100% 100%; position: relative; }
        canvas { position: absolute; top:0; left:0; z-index: 1; }
        .ui-layer { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .hidden { display: none !important; }
        .neon-card { background: rgba(15, 5, 25, 0.95); border: 2px solid var(--ui-color); border-radius: 20px; padding: 30px; text-align: center; width: 90%; max-width: 450px; box-sizing: border-box; font-family: var(--game-font); }
        .ans-btn { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.3); color: #fff; padding: 15px; margin: 10px 0; border-radius: 10px; cursor: pointer; font-family: var(--game-font); font-size: 20px; box-sizing: border-box; transition: 0.2s; }
        .ans-btn:hover { background: rgba(255,255,255,0.15); border-color: var(--ui-color); transform: scale(1.02); }
        
        /* HUD */
        #hud-top { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 40%; z-index: 50; }
        #progress-bar { height: 15px; background: rgba(0,0,0,0.7); border: 2px solid var(--prog-color); border-radius: 10px; overflow: hidden; box-shadow: 0 0 10px var(--prog-color); }
        #progress-fill { height: 100%; background: var(--prog-color); width: 0%; transition: 0.5s; }
        
        .pulse-urgent { animation: pulseRed 0.4s infinite alternate; color: #ff0000 !important; }
        @keyframes pulseRed { from { text-shadow: 0 0 5px #f00; transform: scale(1); } to { text-shadow: 0 0 20px #f00; transform: scale(1.1); } }
    </style>
</head>
<body>

<div id="editor-ui">
    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <img src="https://img.genially.com/67961b32a116fb001568a75e/aa411ed1-1aef-4f00-a1a6-59b64d18dc7a.png" height="50">
            <h1>MAZE TRAP BUILDER v5.0</h1>
        </div>
        <button class="btn-main" style="background:#ffe600; color:#000; border:none; padding:15px 30px;" onclick="generateGeniallyLink()">üîó –°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨ –°–°–´–õ–ö–£ –î–õ–Ø GENIALLY</button>
    </header>

    <div style="padding: 10px 30px; background:#000;">
        <button class="tab-btn active" onclick="openTab('t-design', this)">1. –î–ò–ó–ê–ô–ù</button>
        <button class="tab-btn" onclick="openTab('t-levels', this)">2. –£–†–û–í–ù–ò</button>
        <button class="tab-btn" onclick="openTab('t-questions', this)">3. –í–û–ü–†–û–°–´</button>
        <button class="tab-btn" onclick="openTab('t-preview', this)">4. –ü–†–ï–î–ü–†–û–°–ú–û–¢–†</button>
    </div>

    <main>
        <div id="t-design" class="tab-content active">
            <div class="grid-2">
                <div class="form-group"><label>–Ø–∑—ã–∫:</label><select id="cfg-lang"><option value="ru">–†—É—Å—Å–∫–∏–π</option><option value="kk">–ö–∞–∑–∞—Ö—Å–∫–∏–π</option><option value="en">English</option></select></div>
                <div class="form-group"><label>–®—Ä–∏—Ñ—Ç:</label><select id="cfg-font" onchange="syncStyles()"><option value="'Metamorphous', serif">Metamorphous</option><option value="'Orbitron', sans-serif">Orbitron</option><option value="'Caveat', cursive">Caveat</option></select></div>
                <div class="form-group"><label>–¶–≤–µ—Ç –Ω–µ–æ–Ω–∞:</label><input type="color" id="cfg-ui-color" value="#39ff14" oninput="syncStyles()"></div>
                <div class="form-group"><label>–¶–≤–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞:</label><input type="color" id="cfg-prog-color" value="#00ff66" oninput="syncStyles()"></div>
            </div>
            <h3>–°—Å—ã–ª–∫–∏ –Ω–∞ —Å–ø—Ä–∞–π—Ç—ã (Genially):</h3>
            <div class="grid-2">
                <div class="form-group"><label>–ó–æ–ª–æ—Ç–∞—è –ú–∞—Å–∫–∞:</label><input type="text" id="cfg-img-mask" value="https://img.genially.com/67961b32a116fb001568a75e/4db0de92-1c31-4b38-8c29-df8dc6712266.png"></div>
                <div class="form-group"><label>–ü—É—à–∫–∞ (Shooter):</label><input type="text" id="cfg-img-shooter" value="https://img.genially.com/67961b32a116fb001568a75e/ff229730-a24f-4a1b-8050-c77cb309e646.png"></div>
                <div class="form-group"><label>–°–µ—Ä–¥—Ü–µ:</label><input type="text" id="cfg-img-heart" value="https://img.genially.com/67961b32a116fb001568a75e/213dec47-3717-4811-a68b-20fe7262ec2d.png"></div>
                <div class="form-group"><label>–ß–∞—Å—ã:</label><input type="text" id="cfg-img-clock" value="https://img.genially.com/67961b32a116fb001568a75e/6aa141cb-f83b-4167-9de0-25eeff46e4e2.png"></div>
            </div>
        </div>

        <div id="t-levels" class="tab-content">
            <div id="lvls-list"></div>
            <button class="btn-main" onclick="addLvl()">+ –î–æ–±–∞–≤–∏—Ç—å –£—Ä–æ–≤–µ–Ω—å</button>
        </div>

        <div id="t-questions" class="tab-content">
            <div class="form-group">
                <label>–ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç (–í–æ–ø—Ä–æ—Å. –û—Ç–≤–µ—Ç1 | –û—Ç–≤–µ—Ç2):</label>
                <textarea id="bulk-q" style="height: 300px;" placeholder="I ___ a dog. have | has"></textarea>
            </div>
        </div>

        <div id="t-preview" class="tab-content">
            <div style="background:#000; height: 500px; display:flex; justify-content:center; align-items:center; border: 2px solid var(--ui-color); border-radius:10px;">
                <div class="preview-card" id="p-card">
                    <img id="p-mask" src="" style="width:70px; margin-bottom:15px;">
                    <div id="p-q" style="color:var(--q-color); font-size:24px; margin-bottom:20px;">–≠—Ç–æ –ø—Ä–∏–º–µ—Ä —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞?</div>
                    <div class="ans-btn-preview">–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ 1</div>
                    <div class="ans-btn-preview">–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ 2</div>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="game-ui">
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="hud-top">
            <div id="progress-bar"><div id="progress-fill"></div></div>
            <div id="hud-data" style="display:flex; justify-content:space-between; margin-top:10px; font-weight:bold; font-size:20px;">
                <div id="h-lives">‚ù§Ô∏è 3</div>
                <div id="h-time">‚è±Ô∏è 120</div>
                <div id="h-score">‚≠ê 0</div>
            </div>
        </div>
        
        <div id="start-screen" class="ui-layer">
            <div class="neon-card">
                <h1 id="s-title">MAZE TRAP</h1>
                <p id="s-goal">–¶–µ–ª—å: –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã</p>
                <button class="ans-btn" style="border-color:var(--ui-color)" onclick="startGame()">–ò–ì–†–ê–¢–¨</button>
            </div>
        </div>

        <div id="quiz-screen" class="ui-layer hidden">
            <div class="neon-card">
                <img class="mask-icon" src="" style="width:60px; margin-bottom:10px;">
                <div id="game-q-text" style="color:var(--q-color); font-size:26px; margin-bottom:20px;">?</div>
                <div id="game-ans-box"></div>
            </div>
        </div>

        <div id="end-screen" class="ui-layer hidden">
            <div class="neon-card">
                <h2 id="e-status">GAME OVER</h2>
                <p id="e-score">Score: 0</p>
                <button class="ans-btn" onclick="location.reload()">–ó–ê–ù–û–í–û</button>
            </div>
        </div>
    </div>
</div>

<script>
// --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ù–ê–°–¢–†–û–ô–ö–ò ---
let editorLevels = [{bg: "https://img.genially.com/67961b32a116fb001568a75e/ccde12e3-391b-41b3-9e20-803cfa4b5506.png", path: '[]', qCount: 5}];
const I18N = {
    ru: { start: "–ò–ì–†–ê–¢–¨", goal: "–¶–µ–ª—å: –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã", over: "–ö–û–ù–ï–¶ –ò–ì–†–´", win: "–ü–û–ë–ï–î–ê!" },
    kk: { start: "–û–ô–ù–ê–£", goal: "–ú–∞“õ—Å–∞—Ç: –ë–∞—Ä–ª—ã“õ —Å“±—Ä–∞“õ—Ç–∞—Ä“ì–∞ –∂–∞—É–∞–ø –±–µ—Ä—É", over: "–û–ô–´–ù –ê–Ø“ö–¢–ê–õ–î–´", win: "–ñ–ï“¢–Ü–°!" },
    en: { start: "PLAY", goal: "Goal: Answer all questions", over: "GAME OVER", win: "YOU WIN!" }
};

// --- –õ–û–ì–ò–ö–ê –†–ï–î–ê–ö–¢–û–†–ê ---
function openTab(id, btn) {
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById(id).classList.add('active'); btn.classList.add('active');
    if(id === 't-preview') syncStyles();
}

function addLvl() {
    editorLevels.push({bg: "", path: '[]', qCount: 5}); renderLvls();
}

function renderLvls() {
    const cont = document.getElementById('lvls-list'); cont.innerHTML = '';
    editorLevels.forEach((l, i) => {
        cont.innerHTML += `<div class="form-group">
            <label>–£—Ä–æ–≤–µ–Ω—å ${i+1}</label>
            <input type="text" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ–Ω" value="${l.bg}" onchange="editorLevels[${i}].bg=this.value">
            <textarea placeholder="–ö–æ–¥ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏" onchange="editorLevels[${i}].path=this.value">${l.path}</textarea>
        </div>`;
    });
}
renderLvls();

function syncStyles() {
    const color = document.getElementById('cfg-ui-color').value;
    const font = document.getElementById('cfg-font').value;
    document.documentElement.style.setProperty('--ui-color', color);
    document.documentElement.style.setProperty('--game-font', font);
    document.getElementById('p-card').style.fontFamily = font;
    document.getElementById('p-card').style.borderColor = color;
    document.getElementById('p-mask').src = document.getElementById('cfg-img-mask').value;
}

// –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–°–´–õ–ö–ò (BASE64 —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫)
function generateGeniallyLink() {
    const config = {
        lang: document.getElementById('cfg-lang').value,
        font: document.getElementById('cfg-font').value,
        ui: document.getElementById('cfg-ui-color').value,
        prog: document.getElementById('cfg-prog-color').value,
        mask: document.getElementById('cfg-img-mask').value,
        shooter: document.getElementById('cfg-img-shooter').value,
        heart: document.getElementById('cfg-img-heart').value,
        clock: document.getElementById('cfg-img-clock').value,
        lvls: editorLevels,
        qs: document.getElementById('bulk-q').value
    };
    
    const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(config))));
    const baseUrl = window.location.href.split('?')[0];
    const finalUrl = `${baseUrl}?data=${encoded}`;
    
    const dummy = document.createElement("input");
    document.body.appendChild(dummy);
    dummy.value = finalUrl; dummy.select();
    document.execCommand("copy");
    document.body.removeChild(dummy);
    
    alert("–°–°–´–õ–ö–ê –°–ö–û–ü–ò–†–û–í–ê–ù–ê!\n\n–¢–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤—å—Ç–µ –µ—ë –≤ Genially.");
}

// --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ (–î–í–ò–ñ–û–ö v53) ---
let gameData = null;
let G = { lives: 3, score: 0, time: 120, state: 'idle', currentLvl: 0, qDone: 0 };

window.onload = () => {
    const params = new URLSearchParams(window.location.search);
    if (params.has('data')) {
        document.getElementById('editor-ui').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        try {
            gameData = JSON.parse(decodeURIComponent(escape(atob(params.get('data')))));
            initGameEngine();
        } catch(e) { console.error("–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö", e); }
    }
};

function initGameEngine() {
    const d = gameData;
    document.documentElement.style.setProperty('--ui-color', d.ui);
    document.documentElement.style.setProperty('--game-font', d.font);
    document.documentElement.style.setProperty('--prog-color', d.prog);
    
    const t = I18N[d.lang] || I18N.en;
    document.getElementById('s-goal').innerText = t.goal;
    document.querySelector('#start-screen .ans-btn').innerText = t.start;
    
    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
    const lines = d.qs.split('\n').filter(l => l.includes('|'));
    G.questions = lines.map(line => {
        const parts = line.split('.');
        const qText = parts[0];
        const answers = parts[1].split('|').map(a => a.trim());
        return { q: qText, a: answers[0], options: answers.sort(() => Math.random() - 0.5) };
    });
    
    G.levels = d.lvls.map(l => ({
        bg: l.bg,
        path: JSON.parse(l.path || '[]'),
        qCount: l.qCount
    }));
}

function startGame() {
    document.getElementById('start-screen').classList.add('hidden');
    G.state = 'playing';
    G.time = 120;
    G.lives = 3;
    G.qDone = 0;
    updateHUD();
    
    // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
    G.timer = setInterval(() => {
        if(G.state === 'playing') {
            G.time--;
            if(G.time <= 5) {
                document.getElementById('h-time').classList.add('pulse-urgent');
                // –¢—É—Ç –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–≤—É–∫ —Ç–∏–∫–∞–Ω—å—è
            }
            if(G.time <= 0) endGame(false);
            updateHUD();
        }
    }, 1000);

    // –ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
    runGameLoop();
    
    // –í—Ä–µ–º–µ–Ω–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è: —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –∑–∞–¥–∞–µ–º –≤–æ–ø—Ä–æ—Å
    setTimeout(() => spawnQuestion(), 2000);
}

function spawnQuestion() {
    if(G.state !== 'playing') return;
    G.state = 'paused';
    const q = G.questions[Math.floor(Math.random() * G.questions.length)];
    document.getElementById('quiz-screen').classList.remove('hidden');
    document.getElementById('game-q-text').innerText = q.q;
    const box = document.getElementById('game-ans-box');
    box.innerHTML = '';
    
    q.options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'ans-btn';
        btn.innerText = opt;
        btn.onclick = () => {
            if(opt === q.a) {
                G.qDone++; G.score += 100;
                document.getElementById('quiz-screen').classList.add('hidden');
                G.state = 'playing';
                if(G.qDone >= G.levels[G.currentLvl].qCount) endGame(true);
            } else {
                G.lives--;
                if(G.lives <= 0) endGame(false);
            }
            updateHUD();
        };
        box.appendChild(btn);
    });
}

function updateHUD() {
    document.getElementById('h-lives').innerText = "‚ù§Ô∏è " + G.lives;
    document.getElementById('h-time').innerText = "‚è±Ô∏è " + G.time;
    document.getElementById('h-score').innerText = "‚≠ê " + G.score;
    const progress = (G.qDone / G.levels[G.currentLvl].qCount) * 100;
    document.getElementById('progress-fill').style.width = progress + "%";
}

function endGame(win) {
    G.state = 'over';
    clearInterval(G.timer);
    document.getElementById('end-screen').classList.remove('hidden');
    const t = I18N[gameData.lang] || I18N.en;
    document.getElementById('e-status').innerText = win ? t.win : t.over;
    document.getElementById('e-score').innerText = "Score: " + G.score;
}

// –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ (–≤ –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –≤–∞—à Canvas –¥–≤–∏–∂–æ–∫)
function runGameLoop() {
    const cvs = document.getElementById('gameCanvas');
    const ctx = cvs.getContext('2d');
    cvs.width = window.innerWidth; cvs.height = window.innerHeight;
    
    function draw() {
        if(G.state === 'playing' || G.state === 'paused') {
            ctx.clearRect(0,0,cvs.width, cvs.height);
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –∏ –º–∞—Å–∫–∏
            // (–ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–æ–¥ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∏–∑ v53)
        }
        requestAnimationFrame(draw);
    }
    draw();
}
</script>
</body>
</html>

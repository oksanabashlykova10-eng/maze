<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maze Trap Master Builder</title>
    <link href="https://fonts.googleapis.com/css2?family=Metamorphous&family=Orbitron:wght@400;700;900&family=Caveat:wght@700&family=Cinzel:wght@700&family=Macondo&family=Montserrat:wght@800&family=Comic+Neue:wght@700&family=Pacifico&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           –ë–ê–ó–û–í–ê–Ø –ò–ó–û–õ–Ø–¶–ò–Ø (–†–ï–î–ê–ö–¢–û–† –ò–õ–ò –ò–ì–†–ê)
           ========================================= */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; }
        #editor-ui, #game-ui { display: none; }
        
        /* –†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–û–†–ê */
        body.mode-editor { background: #111; color: #ddd; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-y: auto; }
        body.mode-editor #editor-ui { display: flex; flex-direction: column; min-height: 100vh; }
        
        /* –†–ï–ñ–ò–ú –ò–ì–†–´ */
        body.mode-game { background: #000; overflow: hidden; user-select: none; -webkit-user-select: none; }
        body.mode-game #game-ui { display: block; width: 100%; height: 100vh; }

        /* =========================================
           –°–¢–ò–õ–ò –†–ï–î–ê–ö–¢–û–†–ê (–í–ö–õ–ê–î–ö–ò –ò –û–§–û–†–ú–õ–ï–ù–ò–ï)
           ========================================= */
        :root { --edit-ui: #39ff14; --edit-bg: #1a1a1a; }
        #editor-ui header { display: flex; align-items: center; justify-content: space-between; padding: 15px 30px; background: #000; border-bottom: 2px solid var(--edit-ui); box-shadow: 0 0 15px var(--edit-ui); }
        .logo-container { display: flex; align-items: center; gap: 15px; }
        .logo-container img { height: 50px; filter: drop-shadow(0 0 10px var(--edit-ui)); }
        .logo-container h1 { margin: 0; font-family: 'Metamorphous', serif; color: #fff; font-size: 22px; }
        
        .tabs { display: flex; gap: 5px; padding: 0 30px; background: #000; }
        .tab-btn { background: #222; border: 1px solid #444; color: #aaa; padding: 12px 20px; cursor: pointer; border-radius: 8px 8px 0 0; font-family: 'Metamorphous', serif; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .tab-btn:hover { background: #333; color: #fff; }
        .tab-btn.active { background: var(--edit-bg); color: #ffe600; border-color: #ffe600; border-bottom: none; }

        #editor-ui main { flex-grow: 1; padding: 30px; background: var(--edit-bg); }
        .tab-content { display: none; max-width: 1100px; margin: 0 auto; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .form-group { margin-bottom: 20px; background: #222; padding: 20px; border-radius: 10px; border: 1px solid #333; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .form-group label { display: block; margin-bottom: 8px; color: #fff; font-weight: bold; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; background: #000; color: #fff; border: 1px solid #555; border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .btn-action { background: #222; border: 2px solid var(--edit-ui); color: var(--edit-ui); padding: 12px 25px; border-radius: 30px; cursor: pointer; font-family: 'Metamorphous', serif; font-weight: bold; transition: 0.3s; }
        .btn-action:hover { background: var(--edit-ui); color: #000; box-shadow: 0 0 15px var(--edit-ui); }
        .btn-delete { background: transparent; border: 1px solid #ff3300; color: #ff3300; padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: 0.2s; }
        .btn-delete:hover { background: #ff3300; color: #fff; }
        
        .btn-generate { background: #ffe600; color: #000; border: none; padding: 15px 30px; font-size: 16px; border-radius: 50px; cursor: pointer; font-family: 'Metamorphous', serif; font-weight: bold; box-shadow: 0 0 20px rgba(255, 230, 0, 0.4); transition: 0.3s; }
        .btn-generate:hover { transform: scale(1.05); }

        /* –ü–†–ï–î–ü–†–û–°–ú–û–¢–† */
        .preview-box { width: 100%; height: 500px; background: #000; position: relative; border: 2px solid var(--edit-ui); border-radius: 10px; display: flex; justify-content: center; align-items: center; background-image: radial-gradient(circle, #222 1px, transparent 1px); background-size: 20px 20px; }
        .preview-card { background: rgba(15, 5, 25, 0.95); border: 2px solid var(--edit-ui); border-radius: 20px; padding: 30px; text-align: center; width: 85%; max-width: 400px; box-sizing: border-box; box-shadow: 0 0 15px var(--edit-ui); transition: all 0.3s; }
        .ans-btn-preview { width: 100%; padding: 15px; margin: 10px 0; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; color: #fff; box-sizing: border-box; text-align: center; font-size: 22px; transition: all 0.3s; }

        /* =========================================
           –°–¢–ò–õ–ò –ò–ì–†–´ (–ò–ó–û–õ–ò–†–û–í–ê–ù–´)
           ========================================= */
        #game-ui { --ui-color: #39ff14; --q-color: #ffe600; --prog-color: #00ff66; --q-size: 28px; --a-color: #ffffff; --a-bg: rgba(51, 51, 51, 0.6); --a-size: 22px; --game-font: 'Metamorphous', serif; --neon-glow: 0 0 10px var(--ui-color); font-family: var(--game-font); }
        #game-ui #game-container { position: relative; width: 100%; height: 100%; background-color: #000; background-size: 100% 100%; background-position: center; display: flex; justify-content: center; align-items: center; transition: background-image 0.5s ease; }
        #game-ui canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        
        #game-ui .hud-wrap { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 15px; z-index: 25; width: 45%; max-width: 450px; }
        #game-ui .prog-cont { flex-grow: 1; height: 18px; background: rgba(0, 0, 0, 0.7); border: 2px solid var(--prog-color); border-radius: 20px; box-shadow: 0 0 10px var(--prog-color); overflow: hidden; }
        #game-ui .prog-fill { width: 0%; height: 100%; background: var(--prog-color); box-shadow: 0 0 15px var(--prog-color), inset 0 0 5px rgba(255,255,255,0.8); transition: width 0.5s; }
        #game-ui .val-text { color: #fff; font-size: 24px; font-weight: bold; text-shadow: 0 2px 5px #000; }
        #game-ui .hud-left { position: absolute; top: 15px; left: 20px; display: flex; gap: 20px; z-index: 20; }
        #game-ui .hud-right { position: absolute; top: 15px; right: 20px; z-index: 20; }
        #game-ui .hud-icon { width: 35px; height: 35px; object-fit: contain; filter: drop-shadow(0 0 5px rgba(255,255,255,0.3)); margin-right: 8px; vertical-align: middle; }
        
        .pulse-urgent { animation: pulseRed 0.3s infinite alternate; color: #ff0000 !important; display: inline-block; font-size: 30px;}
        @keyframes pulseRed { from { text-shadow: 0 0 10px #f00; transform: scale(1); } to { text-shadow: 0 0 30px #f00, 0 0 50px #f00; transform: scale(1.2); } }

        #game-ui .game-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: auto; z-index: 100; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.85); }
        .hidden { display: none !important; }
        #game-ui .neon-card { background: rgba(15, 5, 25, 0.95); border: 2px solid var(--ui-color); box-shadow: var(--neon-glow); border-radius: 20px; padding: 30px 20px; text-align: center; color: #fff; width: 90%; max-width: 450px; box-sizing: border-box; }
        
        #game-ui .btn-neon { background: transparent; border: 2px solid var(--ui-color); color: var(--ui-color); padding: 15px 40px; font-size: 22px; border-radius: 50px; cursor: pointer; margin-top: 20px; transition: 0.3s; font-family: var(--game-font); font-weight: bold; box-sizing: border-box; text-transform: uppercase;}
        #game-ui .btn-neon:hover { background: var(--ui-color); color: #000; box-shadow: 0 0 25px var(--ui-color); transform: scale(1.05); }

        #game-ui .ans-btn { width: 100%; background: var(--a-bg); border: 1px solid rgba(255, 255, 255, 0.3); color: var(--a-color); padding: 15px 20px; margin: 10px 0; border-radius: 10px; cursor: pointer; text-align: center; transition: 0.2s; font-size: var(--a-size); font-family: var(--game-font); box-sizing: border-box;}
        #game-ui .ans-btn:hover { background: rgba(255, 255, 255, 0.2); border-color: var(--ui-color); color: var(--ui-color); text-shadow: 0 0 8px var(--ui-color); transform: scale(1.02); }
        
        #game-ui .input-field { width: 90%; padding: 15px; background: rgba(0,0,0,0.5); border: 2px solid var(--ui-color); color:#fff; font-size: var(--a-size); text-align:center; border-radius: 10px; font-family: var(--game-font); margin-bottom: 20px; box-sizing: border-box; outline:none;}

        #game-float-text { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 60px; color: #fff; text-shadow: 0 0 20px #00ffff; font-weight: 900; opacity: 0; pointer-events: none; z-index: 150; transition: opacity 0.5s, transform 0.5s; white-space: nowrap; font-family: var(--game-font); }
        .shake { animation: shakeAnim 0.4s; }
        @keyframes shakeAnim { 0% { transform: translate(0,0); } 20% { transform: translate(-4px, 2px); } 40% { transform: translate(4px, -2px); } 60% { transform: translate(-4px, -2px); } 80% { transform: translate(4px, 2px); } 100% { transform: translate(0,0); } }
    </style>
</head>
<body>

<div id="editor-ui">
    <header>
        <div class="logo-container">
            <img src="https://img.genially.com/67961b32a116fb001568a75e/aa411ed1-1aef-4f00-a1a6-59b64d18dc7a.png">
            <h1>MAZE TRAP: –ú–ê–°–¢–ï–†-–†–ï–î–ê–ö–¢–û–†</h1>
        </div>
        <button class="btn-generate" onclick="generateGeniallyLink()">üöÄ –°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨ –°–°–´–õ–ö–£</button>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('tab-design', this)">1. –ù–ê–°–¢–†–û–ô–ö–ò & –î–ò–ó–ê–ô–ù</button>
        <button class="tab-btn" onclick="openTab('tab-levels', this)">2. –£–†–û–í–ù–ò –ò–ì–†–´</button>
        <button class="tab-btn" onclick="openTab('tab-questions', this)">3. –ë–ê–ó–ê –í–û–ü–†–û–°–û–í</button>
        <button class="tab-btn" onclick="openTab('tab-preview', this)">4. –ü–†–ï–î–ü–†–û–°–ú–û–¢–†</button>
    </div>

    <main>
        <div id="tab-design" class="tab-content active">
            <h2>–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <div class="grid-2">
                <div class="form-group">
                    <label>–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:</label>
                    <select id="cfg-lang">
                        <option value="en">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π (English)</option>
                        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                        <option value="de">–ù–µ–º–µ—Ü–∫–∏–π (Deutsch)</option>
                        <option value="fr">–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π (Fran√ßais)</option>
                        <option value="kk">–ö–∞–∑–∞—Ö—Å–∫–∏–π (“ö–∞–∑–∞“õ—à–∞)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–®—Ä–∏—Ñ—Ç –∏–≥—Ä—ã:</label>
                    <select id="cfg-font" onchange="updatePreview()">
                        <option value="'Metamorphous', serif">Metamorphous (–§—ç–Ω—Ç–µ–∑–∏)</option>
                        <option value="'Orbitron', sans-serif">Orbitron (–ö–æ—Å–º–æ—Å)</option>
                        <option value="'Caveat', cursive">Caveat (–†—É–∫–æ–ø–∏—Å–Ω—ã–π)</option>
                        <option value="'Montserrat', sans-serif">Montserrat (–°—Ç—Ä–æ–≥–∏–π)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–¶–≤–µ—Ç –Ω–µ–æ–Ω–∞ (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å):</label>
                    <input type="color" id="cfg-ui-color" value="#39ff14" oninput="updatePreview()">
                </div>
                <div class="form-group">
                    <label>–í—Ä–µ–º—è –Ω–∞ —É—Ä–æ–≤–µ–Ω—å (—Å–µ–∫—É–Ω–¥—ã):</label>
                    <input type="number" id="cfg-time" value="120">
                </div>
            </div>
            <h2>–°–ø—Ä–∞–π—Ç—ã (–°—Å—ã–ª–∫–∏ –∏–∑ Genially)</h2>
            <div class="grid-2">
                <div class="form-group"><label>–ó–æ–ª–æ—Ç–∞—è –ú–∞—Å–∫–∞ (–¶–µ–ª—å):</label><input type="text" id="cfg-mask" value="https://img.genially.com/67961b32a116fb001568a75e/4db0de92-1c31-4b38-8c29-df8dc6712266.png" oninput="updatePreview()"></div>
                <div class="form-group"><label>–°–µ—Ä–¥–µ—á–∫–æ (–ñ–∏–∑–Ω–∏):</label><input type="text" id="cfg-heart" value="https://img.genially.com/67961b32a116fb001568a75e/213dec47-3717-4811-a68b-20fe7262ec2d.png"></div>
                <div class="form-group"><label>–ß–∞—Å—ã (–¢–∞–π–º–µ—Ä):</label><input type="text" id="cfg-clock" value="https://img.genially.com/67961b32a116fb001568a75e/6aa141cb-f83b-4167-9de0-25eeff46e4e2.png"></div>
                <div class="form-group"><label>–ü—É—à–∫–∞ (–ò–≥—Ä–æ–∫):</label><input type="text" id="cfg-shooter" value="https://img.genially.com/67961b32a116fb001568a75e/ff229730-a24f-4a1b-8050-c77cb309e646.png"></div>
            </div>
        </div>

        <div id="tab-levels" class="tab-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –£—Ä–æ–≤–Ω–µ–π</h2>
                <button class="btn-action" onclick="addLevel()">+ –î–û–ë–ê–í–ò–¢–¨ –£–†–û–í–ï–ù–¨</button>
            </div>
            <div id="levels-container">
                </div>
        </div>

        <div id="tab-questions" class="tab-content">
            <h2>–ë–∞–∑–∞ –≤–æ–ø—Ä–æ—Å–æ–≤</h2>
            <div class="form-group" style="background: #111; border-color: #ffe600;">
                <label style="color: #ffe600;">üí° –ö–∞–∫ –≤–≤–æ–¥–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã?</label>
                <p style="font-size:13px; color:#ccc; margin-top:0;">
                    <b>1. –í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞:</b> –í–æ–ø—Ä–æ—Å . –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π | –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π<br>
                    <i>–ü—Ä–∏–º–µ—Ä: Dog –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –∫–∞–∫ . –°–æ–±–∞–∫–∞ | –ö–æ—Ç | –ú—ã—à—å</i><br><br>
                    <b>2. –†—É—á–Ω–æ–π –≤–≤–æ–¥ —Å–ª–æ–≤–∞ (–≤–ø–∏—à–∏—Ç–µ type:input):</b> type:input –í–æ–ø—Ä–æ—Å . –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π–û—Ç–≤–µ—Ç<br>
                    <i>–ü—Ä–∏–º–µ—Ä: type:input –ù–∞–ø–∏—à–∏ –ø–æ-–∞–Ω–≥–ª–∏–π—Å–∫–∏ "–ö–æ—Ç" . cat</i>
                </p>
            </div>
            <div class="form-group">
                <textarea id="cfg-questions" style="height: 350px; font-size: 16px;" placeholder="–í—Å—Ç–∞–≤–ª—è–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã —Å—é–¥–∞..."></textarea>
            </div>
        </div>

        <div id="tab-preview" class="tab-content">
            <h2>–¢–∞–∫ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–≥—Ä—ã</h2>
            <div class="preview-box">
                <div class="preview-card" id="p-card">
                    <img id="p-mask" src="" style="width:80px; margin-bottom:15px; filter: drop-shadow(0 0 10px #fff);">
                    <div id="p-q" style="color:#ffe600; font-size:26px; margin-bottom:20px;">–≠—Ç–æ –ø—Ä–∏–º–µ—Ä –≤–∞—à–µ–≥–æ —à—Ä–∏—Ñ—Ç–∞?</div>
                    <div class="ans-btn-preview" id="p-btn1">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</div>
                    <div class="ans-btn-preview" id="p-btn2">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</div>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="game-ui">
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <div class="hud-wrap">
            <div class="prog-cont"><div id="game-prog-fill" class="prog-fill"></div></div>
            <span id="game-q-disp" style="color:var(--prog-color); font-size:22px; font-weight:bold;">0/0</span>
        </div>

        <div class="hud-left">
            <div class="hud-item"><img class="hud-icon dyn-heart" src=""><span id="game-lives" class="val-text">3</span></div>
            <div class="hud-item"><img class="hud-icon" src="https://img.genially.com/67961b32a116fb001568a75e/03a676ec-a263-478b-a675-d6e17a7a36e1.png"><span id="game-score" class="val-text">0</span></div>
        </div>

        <div class="hud-right">
            <div class="hud-item"><img class="hud-icon dyn-clock" src=""><span id="game-time" class="val-text">120</span></div>
        </div>

        <div id="game-float-text"></div>

        <div id="start-screen" class="game-layer">
            <div class="neon-card" style="max-width: 750px;">
                <img src="" class="dyn-mask" style="width:90px; margin-bottom:15px; filter: drop-shadow(0 0 10px var(--ui-color));">
                <h1 style="margin:0 0 10px; color:#fff; text-shadow:0 0 10px var(--ui-color); font-size:2.5em;">MAZE TRAP</h1>
                <p id="t-goal" style="color:var(--ui-color); font-size:1.4em; margin-bottom:20px; text-transform:uppercase;">GOAL: ANSWER ALL QUESTIONS</p>
                <button id="btn-start" class="btn-neon">START GAME</button>
            </div>
        </div>

        <div id="quiz-screen" class="game-layer hidden">
            <div class="neon-card">
                <img src="" class="dyn-mask" style="width:70px; margin-bottom:15px;">
                <h2 id="q-text" style="color:var(--q-color); text-shadow:0 0 10px var(--q-color); font-size:var(--q-size); margin-bottom:20px;">?</h2>
                <div id="q-content" style="width:100%;"></div>
            </div>
        </div>

        <div id="end-screen" class="game-layer hidden">
            <div class="neon-card">
                <img src="" class="dyn-mask" style="width:70px; margin-bottom:15px;">
                <h1 id="end-title" style="margin:0 0 10px; color:#fff; text-shadow:0 0 10px var(--ui-color); font-size:2.2em;">GAME OVER</h1>
                <p id="st-total" style="color:var(--ui-color); font-size:1.8em; font-weight:bold; margin:20px 0;">SCORE: 0</p>
                <button id="btn-restart" class="btn-neon">PLAY AGAIN</button>
            </div>
        </div>
    </div>
</div>

<script>
// ==========================================
// –õ–û–ì–ò–ö–ê –ú–ê–†–®–†–£–¢–ò–ó–ê–¶–ò–ò (–ö–¢–û –û–¢–ö–†–´–õ –§–ê–ô–õ?)
// ==========================================
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.has('data')) {
    document.body.classList.add('mode-game');
    try {
        const decoded = JSON.parse(decodeURIComponent(escape(atob(urlParams.get('data')))));
        initGameEngine(decoded);
    } catch(e) { alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É."); }
} else {
    document.body.classList.add('mode-editor');
    initEditor();
}

// ==========================================
// –õ–û–ì–ò–ö–ê –†–ï–î–ê–ö–¢–û–†–ê
// ==========================================
let editorLevels = [
    {bg: "https://img.genially.com/67961b32a116fb001568a75e/ccde12e3-391b-41b3-9e20-803cfa4b5506.png", path: '[{"x":0.0254,"y":0.444},{"x":0.5101,"y":0.4726}]', qCount: 5}
];

function initEditor() {
    renderLevels();
    updatePreview();
}

function openTab(id, btn) {
    document.querySelectorAll('#editor-ui .tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#editor-ui .tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
    if(id === 'tab-preview') updatePreview();
}

function updatePreview() {
    const font = document.getElementById('cfg-font').value;
    const color = document.getElementById('cfg-ui-color').value;
    const card = document.getElementById('p-card');
    
    card.style.fontFamily = font;
    card.style.borderColor = color;
    card.style.boxShadow = `0 0 15px ${color}`;
    document.getElementById('p-mask').src = document.getElementById('cfg-mask').value;
    document.getElementById('p-mask').style.filter = `drop-shadow(0 0 10px ${color})`;
    
    document.getElementById('p-btn1').style.borderColor = color;
    document.getElementById('p-btn1').style.color = color;
    document.getElementById('p-btn1').style.textShadow = `0 0 8px ${color}`;
    document.getElementById('p-btn1').style.background = `rgba(255,255,255,0.15)`;
}

// –ü–†–ê–í–ò–õ–¨–ù–û–ï –î–û–ë–ê–í–õ–ï–ù–ò–ï –£–†–û–í–ù–ï–ô (–ë–ï–ó –£–î–ê–õ–ï–ù–ò–Ø –í–í–ï–î–ï–ù–ù–û–ì–û –¢–ï–ö–°–¢–ê)
function renderLevels() {
    const cont = document.getElementById('levels-container');
    cont.innerHTML = '';
    editorLevels.forEach((l, i) => {
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h3 style="margin:0; color:var(--edit-ui);">–£–†–û–í–ï–ù–¨ ${i+1}</h3>
                <button onclick="removeLevel(${i})" class="btn-delete">‚úñ –£–¥–∞–ª–∏—Ç—å</button>
            </div>
            <label>–§–æ–Ω (—Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É):</label>
            <input type="text" value="${l.bg}" onchange="editorLevels[${i}].bg=this.value" style="margin-bottom:10px;">
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ:</label>
            <input type="number" value="${l.qCount}" onchange="editorLevels[${i}].qCount=parseInt(this.value)" style="margin-bottom:10px;">
            <label>–ö–æ–¥ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–∑ Path Generator):</label>
            <textarea onchange="editorLevels[${i}].path=this.value">${l.path}</textarea>
        `;
        cont.appendChild(div);
    });
}

function addLevel() { editorLevels.push({bg: "", path: '[]', qCount: 5}); renderLevels(); }
function removeLevel(idx) { editorLevels.splice(idx, 1); renderLevels(); }

function generateGeniallyLink() {
    const questionsRaw = document.getElementById('cfg-questions').value.split('\n');
    const questionsArr = [];
    
    // –£–º–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –≤–æ–ø—Ä–æ—Å–æ–≤
    questionsRaw.forEach(line => {
        if(line.includes('.')) {
            let isInput = line.includes('type:input');
            let cleanLine = line.replace('type:input', '').trim();
            const parts = cleanLine.split('.');
            if(parts.length >= 2) {
                const qText = parts[0].trim();
                const opts = parts[1].split('|').map(s=>s.trim());
                if(isInput) {
                    questionsArr.push({ type: 'input', q: qText, a: opts[0], lvl: 'all' });
                } else {
                    questionsArr.push({ type: 'mcq', q: qText, o: [...opts].sort(()=>Math.random()-0.5), a: opts[0], lvl: 'all' });
                }
            }
        }
    });

    if(questionsArr.length === 0) {
        alert("–í–Ω–∏–º–∞–Ω–∏–µ! –í—ã –Ω–µ –¥–æ–±–∞–≤–∏–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞. –ò–≥—Ä–∞ –º–æ–∂–µ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è.");
    }

    const config = {
        lang: document.getElementById('cfg-lang').value,
        fontFamily: document.getElementById('cfg-font').value,
        uiColor: document.getElementById('cfg-ui-color').value,
        progColor: "#00ff66",
        timerStart: parseInt(document.getElementById('cfg-time').value) || 120,
        imgMask: document.getElementById('cfg-mask').value,
        imgHeart: document.getElementById('cfg-heart').value,
        imgClock: document.getElementById('cfg-clock').value,
        imgShooter: document.getElementById('cfg-shooter').value,
        levels: editorLevels.map(l => ({ bg: `url('${l.bg}')`, path: JSON.parse(l.path || '[]'), qCount: l.qCount })),
        questions: questionsArr
    };

    const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(config))));
    const baseUrl = window.location.href.split('?')[0];
    const finalUrl = `${baseUrl}?data=${encoded}`;
    
    const dummy = document.createElement("textarea");
    document.body.appendChild(dummy);
    dummy.value = finalUrl;
    dummy.select();
    document.execCommand("copy");
    document.body.removeChild(dummy);
    
    alert("‚úÖ –°–°–´–õ–ö–ê –°–ö–û–ü–ò–†–û–í–ê–ù–ê!\n\n–¢–µ–ø–µ—Ä—å –≤—Å—Ç–∞–≤—å—Ç–µ –µ—ë –≤ Genially (–í—Å—Ç–∞–≤–∏—Ç—å -> –î—Ä—É–≥–∏–µ).");
}

// ==========================================
// –õ–û–ì–ò–ö–ê –ò–ì–†–´ (v53.1)
// ==========================================
const I18N = {
    en: { start: "START GAME", next: "NEXT LEVEL", play: "PLAY AGAIN", over: "GAME OVER", cleared: "LEVEL CLEARED!", quest: "QUEST COMPLETED!", goal: "GOAL: ANSWER ALL QUESTIONS" },
    ru: { start: "–ù–ê–ß–ê–¢–¨ –ò–ì–†–£", next: "–°–õ–ï–î–£–Æ–©–ò–ô –£–†–û–í–ï–ù–¨", play: "–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê", over: "–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê", cleared: "–£–†–û–í–ï–ù–¨ –ü–†–û–ô–î–ï–ù!", quest: "–ö–í–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù!", goal: "–¶–ï–õ–¨: –û–¢–í–ï–¢–ò–¢–¨ –ù–ê –í–°–ï –í–û–ü–†–û–°–´" },
    de: { start: "SPIEL STARTEN", next: "N√ÑCHSTES LEVEL", play: "NOCHMAL SPIELEN", over: "SPIEL VORBEI", cleared: "LEVEL GESCHAFFT!", quest: "QUEST ABGESCHLOSSEN!", goal: "ZIEL: ALLE FRAGEN BEANTWORTEN" },
    fr: { start: "COMMENCER", next: "NIVEAU SUIVANT", play: "REJOUER", over: "JEU TERMIN√â", cleared: "NIVEAU TERMIN√â!", quest: "QU√äTE ACHEV√âE!", goal: "OBJECTIF: R√âPONDRE √Ä TOUT" },
    kk: { start: "–û–ô–´–ù–î–´ –ë–ê–°–¢–ê–£", next: "–ö–ï–õ–ï–°–Ü –î–ï“¢–ì–ï–ô", play: "“ö–ê–ô–¢–ê –û–ô–ù–ê–£", over: "–û–ô–´–ù –ê–Ø“ö–¢–ê–õ–î–´", cleared: "–î–ï“¢–ì–ï–ô –ê–Ø“ö–¢–ê–õ–î–´!", quest: "–ö–í–ï–°–¢ –ê–Ø“ö–¢–ê–õ–î–´!", goal: "–ú–ê“ö–°–ê–¢: –ë–ê–†–õ–´“ö –°“∞–†–ê“ö–¢–ê–†“í–ê –ñ–ê–£–ê–ü –ë–ï–†–£" }
};

let GAME_CFG = null;
let G_ENGINE = null;

function initGameEngine(data) {
    GAME_CFG = data;
    const root = document.getElementById('game-ui');
    root.style.setProperty('--game-font', data.fontFamily);
    root.style.setProperty('--ui-color', data.uiColor);
    
    document.querySelectorAll('.dyn-mask').forEach(el => el.src = data.imgMask);
    document.querySelectorAll('.dyn-heart').forEach(el => el.src = data.imgHeart);
    document.querySelectorAll('.dyn-clock').forEach(el => el.src = data.imgClock);

    const t = I18N[data.lang] || I18N.ru;
    document.getElementById('t-goal').innerText = t.goal;
    document.getElementById('btn-start').innerText = t.start;

    G_ENGINE = new GameCore();
}

class Part {
    constructor(x,y,c){ this.x=x; this.y=y; this.c=c; this.life=1; this.vx=(Math.random()-0.5)*6; this.vy=(Math.random()-0.5)*6; }
    up(){ this.x+=this.vx; this.y+=this.vy; this.life-=0.04; }
    draw(ctx){ ctx.globalAlpha=this.life; ctx.fillStyle=this.c; ctx.beginPath(); ctx.arc(this.x,this.y,4,0,7); ctx.fill(); ctx.globalAlpha=1; }
}

class GameCore {
    constructor() {
        this.cvs = document.getElementById('gameCanvas'); this.ctx = this.cvs.getContext('2d');
        this.w=800; this.h=600; this.state='idle';
        this.score=0; this.lives=3; this.currentLevelIndex = 0; this.player={x:400, y:550};
        
        this.ASSETS = {};
        this.IMG_URLS = {
            c_red: 'https://img.genially.com/67961b32a116fb001568a75e/966b4fee-e623-41f6-8bf5-f6d84662cf56.png',
            c_blue: 'https://img.genially.com/67961b32a116fb001568a75e/9d4f9653-a305-4ecd-b49a-6094fbacaf74.png',
            c_green: 'https://img.genially.com/67961b32a116fb001568a75e/c377dca1-25bb-4924-8060-430631ae28cc.png',
            t_question: 'https://img.genially.com/67961b32a116fb001568a75e/87a94615-9492-4862-8d39-d5a93e8fb3e2.png',
            shooter: GAME_CFG.imgShooter,
            center_mask: GAME_CFG.imgMask
        };
        for(let key in this.IMG_URLS) { this.ASSETS[key] = new Image(); this.ASSETS[key].src = this.IMG_URLS[key]; }
        
        this.bindEvents(); this.applyLevel(0);
        this.resize(); setInterval(()=>this.resize(), 500); this.loop();
    }

    bindEvents() {
        const move=(e)=>{ const r=this.cvs.getBoundingClientRect(); const cx=e.touches?e.touches[0].clientX:e.clientX; this.player.x=Math.max(35, Math.min(this.w-35, cx-r.left)); };
        this.cvs.addEventListener('mousemove',move); this.cvs.addEventListener('touchmove',e=>{e.preventDefault();move(e)},{passive:false});
        this.cvs.addEventListener('click',()=>this.shoot());
        document.getElementById('btn-start').onclick = () => this.start(0);
        document.getElementById('btn-restart').onclick = () => { 
            document.getElementById('end-screen').classList.add('hidden'); 
            if (this.isWin && this.currentLevelIndex < GAME_CFG.levels.length - 1) { this.start(this.currentLevelIndex + 1); } 
            else { document.getElementById('start-screen').classList.remove('hidden'); } 
        };
    }

    applyLevel(idx) { document.getElementById('game-container').style.backgroundImage = GAME_CFG.levels[idx].bg; this.genPath(); }

    resize() { const el=document.getElementById('game-container'); if(el.clientWidth>0 && (el.clientWidth!==this.w || el.clientHeight!==this.h)){ this.w=el.clientWidth; this.h=el.clientHeight; this.cvs.width=this.w; this.cvs.height=this.h; this.player.y = this.h - 50; this.genPath(); } }

    genPath() {
        if(this.h<100) return; let raw = GAME_CFG.levels[this.currentLevelIndex].path.map(p => ({ x: p.x * this.w, y: p.y * this.h }));
        this.path=[]; if(raw.length>0) this.path.push(raw[0]);
        for(let i=0; i<raw.length-1; i++){ let a=raw[i], b=raw[i+1], d=Math.hypot(b.x-a.x, b.y-a.y); let steps=Math.ceil(d); for(let k=1; k<=steps; k++){ let t=k/steps; this.path.push({x:a.x+(b.x-a.x)*t, y:a.y+(b.y-a.y)*t}); } }
    }

    start(lvlIdx) {
        document.querySelectorAll('.game-layer').forEach(el=>el.classList.add('hidden')); this.state='playing';
        if (lvlIdx === 0) { this.score=0; this.lives=3; }
        this.currentLevelIndex = lvlIdx; this.applyLevel(lvlIdx);
        
        let targetCount = GAME_CFG.levels[lvlIdx].qCount;
        let availableQ = [...GAME_CFG.questions].sort(() => Math.random() - 0.5);
        this.levelQuestions = availableQ.slice(0, targetCount);
        if(this.levelQuestions.length === 0) { this.levelQuestions = [{type:"mcq", q:"NO QUESTIONS", o:["OK"], a:"OK"}]; }
        
        this.time = GAME_CFG.timerStart; this.qDone=0; this.nextQIndex=0; 
        this.balls=[]; this.bullets=[]; this.parts=[]; this.queue=[]; this.curSpacing=44; this.nextCol=this.rndCol();
        
        for(let i=0; i<this.levelQuestions.length; i++) this.queue.push('question');
        while(this.queue.length < 15) this.queue.push('normal');
        this.queue.sort(() => Math.random() - 0.5);
        this.ui();
        
        if(this.tmr) clearInterval(this.tmr);
        this.tmr=setInterval(()=>{
            if(this.state==='playing' || this.state==='paused_for_q'){
                this.time--;
                let timeDisp = document.getElementById('game-time');
                if (this.time <= 5 && this.time > 0) { timeDisp.classList.add('pulse-urgent'); } 
                else { timeDisp.classList.remove('pulse-urgent'); }
                this.ui();
                if(this.time<=0) this.over(false);
            }
        },1000);
    }

    rndCol(){ const cols=["red","blue","green"]; return cols[Math.floor(Math.random()*cols.length)]; }
    spawn() { if(this.queue.length===0) return; let t = this.queue.shift(); this.balls.push({ d:0, type: t, c: this.rndCol() }); }
    shoot() { if(this.state!=='playing' || this.bullets.length>0) return; this.bullets.push({x:this.player.x, y:this.player.y-20, c:this.nextCol}); this.nextCol=this.rndCol(); }

    update() {
        if(this.state!=='playing') return;
        let need=this.balls.length===0; if(!need && this.balls[this.balls.length-1].d > this.curSpacing) need=true; if(need) this.spawn();
        if(this.balls.length === 0 && this.queue.length === 0) { this.over(true); return; }

        for(let i=0; i<this.balls.length; i++){
            let b=this.balls[i]; b.d+=1.2;
            if(b.d>=this.path.length-1) { this.over(false); return; }
            let idx=Math.floor(b.d); let p1=this.path[idx]||this.path[this.path.length-1], p2=this.path[idx+1]||p1, f=b.d-idx;
            b.x=p1.x+(p2.x-p1.x)*f; b.y=p1.y+(p2.y-p1.y)*f;
        }

        for(let i=this.bullets.length-1; i>=0; i--){
            let bu=this.bullets[i]; bu.y -= 24; if(bu.y<-50) { this.bullets.splice(i,1); continue; }
            let hit=false;
            for(let j=0; j<this.balls.length; j++){ if(Math.hypot(bu.x-this.balls[j].x, bu.y-this.balls[j].y) < 30){ this.hit(j, bu); hit=true; break; } }
            if(hit) this.bullets.splice(i,1);
        }
        for(let i=this.parts.length-1; i>=0; i--){ this.parts[i].up(); if(this.parts[i].life<=0) this.parts.splice(i,1); }
    }

    hit(idx, bullet) {
        let b = this.balls[idx]; for(let k=0;k<8;k++) this.parts.push(new Part(b.x, b.y, "#fff"));
        if(b.type === 'normal' && b.c === bullet.c) { this.score += 50; this.showFlash("MATCH!"); }
        if(b.type === 'question'){ this.state='paused_for_q'; this.balls.splice(idx,1); this.ask(); return; }
        this.balls.splice(idx,1); this.ui();
    }

    showFlash(txt){ const el=document.getElementById('game-float-text'); el.innerText=txt; el.style.opacity=1; el.style.transform="translate(-50%,-50%) scale(1.5)"; setTimeout(()=>{ el.style.opacity=0; el.style.transform="translate(-50%,-50%) scale(1)"; },800); }

    ask() {
        const q = this.levelQuestions[this.nextQIndex % this.levelQuestions.length]; this.nextQIndex++; 
        document.getElementById('quiz-screen').classList.remove('hidden'); 
        document.getElementById('q-text').innerText = q.q; 
        const c = document.getElementById('q-content'); c.innerHTML='';
        
        if (q.type === 'mcq') {
            q.o.forEach(opt=>{ 
                const b=document.createElement('div'); b.className='ans-btn'; b.innerText=opt; 
                b.onclick=()=>this.check(opt===q.a); 
                c.appendChild(b); 
            });
        } else if (q.type === 'input') {
            const w = document.createElement('div'); w.style.textAlign="center";
            const i=document.createElement('input'); i.className='input-field'; 
            const b=document.createElement('button'); b.className='btn-neon'; b.innerText="OK"; 
            b.onclick=()=>this.check(i.value.trim().toLowerCase() === q.a.toLowerCase()); 
            w.append(i,b); c.appendChild(w); setTimeout(()=>i.focus(), 100);
        }
    }

    check(isOk) {
        document.getElementById('quiz-screen').classList.add('hidden');
        if(isOk) { this.qDone++; this.score+=100; this.balls.forEach(bl => bl.d = Math.max(0, bl.d - 100)); this.showFlash("CORRECT!"); } 
        else { this.lives--; document.getElementById('game-container').classList.add('shake'); setTimeout(()=>document.getElementById('game-container').classList.remove('shake'),400); }
        this.ui();
        if(this.lives<=0) { this.over(false); }
        else if(this.qDone >= this.levelQuestions.length) { this.over(true); } 
        else { this.state='playing'; }
    }

    over(win) {
        this.state='gameover'; clearInterval(this.tmr); this.isWin = win; 
        document.getElementById('end-screen').classList.remove('hidden');
        const t = I18N[GAME_CFG.lang] || I18N.ru;
        let titleEl = document.getElementById('end-title'); let btnEl = document.getElementById('btn-restart');
        
        if (win) {
            if (this.currentLevelIndex < GAME_CFG.levels.length - 1) { titleEl.innerText = t.cleared; btnEl.innerText = t.next; } 
            else { titleEl.innerText = t.quest; btnEl.innerText = t.play; }
        } else { titleEl.innerText = t.over; btnEl.innerText = t.play; }
        document.getElementById('st-total').innerText = "SCORE: " + this.score; 
    }

    ui() {
        document.getElementById('game-lives').innerText=this.lives; document.getElementById('game-score').innerText=this.score;
        document.getElementById('game-time').innerText=this.time; document.getElementById('game-q-disp').innerText=this.qDone+"/"+this.levelQuestions.length;
        document.getElementById('game-prog-fill').style.width = ((this.qDone / this.levelQuestions.length) * 100) + '%';
    }

    drawImg(key, x, y, size) { if(this.ASSETS[key] && this.ASSETS[key].complete) { this.ctx.drawImage(this.ASSETS[key], x - size/2, y - size/2, size, size); } }

    draw() {
        this.ctx.clearRect(0,0,this.w,this.h);

        if(this.path && this.path.length>0){
            const last = this.path[this.path.length-1];
            if (this.ASSETS['center_mask'] && this.ASSETS['center_mask'].complete) {
                this.ctx.save(); let maskSize = 90;
                if (this.time <= 5 && this.time > 0 && this.state !== 'gameover') {
                    this.ctx.shadowBlur = 20 + Math.abs(Math.sin(Date.now() / 100)) * 30; this.ctx.shadowColor = "#ff0000"; maskSize = 90 + Math.abs(Math.sin(Date.now() / 100)) * 20; 
                } else { this.ctx.shadowBlur = 20; this.ctx.shadowColor = GAME_CFG.uiColor; }
                this.ctx.drawImage(this.ASSETS['center_mask'], last.x - maskSize/2, last.y - maskSize/2, maskSize, maskSize); this.ctx.restore();
            }
        }

        this.parts.forEach(p=>p.draw(this.ctx));
        this.balls.forEach(b=>{ let imgKey = b.type==='question' ? 't_question' : 'c_'+b.c; this.drawImg(imgKey, b.x, b.y, 50); });
        this.bullets.forEach(b=>{ this.drawImg("c_" + b.c, b.x, b.y, 44); });

        this.ctx.save(); this.ctx.translate(this.player.x, this.player.y);
        this.drawImg("shooter", 0, 0, 90);
        if(this.bullets.length===0){ this.drawImg("c_" + this.nextCol, 0, -15, 30); }
        this.ctx.restore();
    }
    loop() { this.update(); this.draw(); requestAnimationFrame(()=>this.loop()); }
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maze Trap Master Builder</title>
    <link href="https://fonts.googleapis.com/css2?family=Metamorphous&family=Orbitron:wght@700&family=Caveat:wght@700&family=Cinzel:wght@700&family=Macondo&family=Montserrat:wght@800&family=Comic+Neue:wght@700&family=Pacifico&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --ui-color: #39ff14; --q-color: #ffe600; --q-size: 28px; --a-color: #ffffff;
            --a-bg: rgba(255, 255, 255, 0.05); --a-size: 22px; --game-font: 'Metamorphous', serif;
            --bg-dark: #111; --panel-bg: #1a1a1a; --neon-glow: 0 0 10px var(--ui-color);
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; }
        
        /* –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ –†–ï–ñ–ò–ú–û–í */
        #editor-ui, #game-ui { display: none; }
        body.mode-editor { background: var(--bg-dark); color: #ddd; font-family: 'Segoe UI', sans-serif; overflow-y: auto; }
        body.mode-editor #editor-ui { display: block; }
        body.mode-game { background: #000; overflow: hidden; }
        body.mode-game #game-ui { display: block; width: 100%; height: 100vh; }

        /* --- –°–¢–ò–õ–ò –†–ï–î–ê–ö–¢–û–†–ê --- */
        header { display: flex; align-items: center; justify-content: space-between; padding: 15px 30px; background: #000; border-bottom: 2px solid var(--ui-color); box-shadow: 0 0 15px var(--ui-color); }
        .logo-container { display: flex; align-items: center; gap: 15px; }
        .logo-container img { height: 60px; filter: drop-shadow(0 0 10px var(--ui-color)); }
        .logo-container h1 { margin: 0; font-family: 'Metamorphous', serif; color: #fff; text-shadow: 0 0 10px var(--ui-color); font-size: 22px; }
        
        .tabs { display: flex; gap: 5px; padding: 0 30px; background: #000; }
        .tab-btn { background: #222; border: 1px solid #444; color: #aaa; padding: 10px 15px; cursor: pointer; border-radius: 5px 5px 0 0; font-family: 'Metamorphous', serif; }
        .tab-btn:hover { background: #333; color: #fff; }
        .tab-btn.active { background: var(--panel-bg); color: #ffe600; border-color: #ffe600; border-bottom: none; }

        main { padding: 25px; background: var(--panel-bg); min-height: calc(100vh - 160px); }
        .tab-content { display: none; max-width: 1100px; margin: 0 auto; }
        .tab-content.active { display: block; }

        .form-group { margin-bottom: 15px; background: #222; padding: 15px; border-radius: 8px; border: 1px solid #333; }
        label { display: block; margin-bottom: 8px; color: #fff; font-weight: bold; font-size: 14px; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 10px; background: #000; color: #fff; border: 1px solid #555; border-radius: 5px; box-sizing: border-box; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        
        .color-picker-group { display: flex; align-items: center; justify-content: space-between; background: #000; padding: 10px; border-radius: 5px; border: 1px solid #555; }
        .color-picker-group input[type="color"] { width: 40px; height: 30px; padding: 0; border: none; cursor: pointer; background: transparent; }
        .color-picker-group input[type="text"] { width: 80px; border: none; padding: 5px; border-bottom: 1px solid #555; border-radius: 0; margin-left: 10px; }

        .btn-main { background: transparent; border: 2px solid var(--ui-color); color: var(--ui-color); padding: 12px 25px; border-radius: 30px; cursor: pointer; font-family: 'Metamorphous', serif; font-weight: bold; transition: 0.3s; }
        .btn-main:hover { background: var(--ui-color); color: #000; box-shadow: 0 0 15px var(--ui-color); }
        .btn-del { background: #ff3333; color: #fff; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }

        /* –ü–†–ï–î–ü–†–û–°–ú–û–¢–† */
        .preview-box { width: 100%; height: 500px; background: #000; background-size: cover; background-position: center; position: relative; border: 2px solid var(--ui-color); border-radius: 10px; overflow: hidden; }
        .preview-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; transition: 0.3s; }
        .preview-overlay.hidden { opacity: 0; pointer-events: none; }
        .preview-card { background: rgba(15, 5, 25, 0.95); border: 1px solid var(--ui-color); border-radius: 20px; padding: 30px; text-align: center; width: 85%; max-width: 400px; box-sizing: border-box; box-shadow: var(--neon-glow); }
        #p-q { color: var(--q-color); font-size: var(--q-size); margin-bottom: 20px; font-family: var(--game-font); }
        .ans-btn-preview { width: 100%; padding: 15px; margin: 10px 0; background: var(--a-bg); border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; color: var(--a-color); box-sizing: border-box; text-align: center; font-size: var(--a-size); font-family: var(--game-font); }

        /* –°–ü–ò–°–û–ö –í–û–ü–†–û–°–û–í */
        .q-item { background: #000; border: 1px solid #444; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: flex-start; }
        .q-item-content { flex-grow: 1; }
        .q-item-type { font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 5px; }
        .q-item-q { font-size: 16px; color: #ffe600; font-weight: bold; margin-bottom: 5px; }
        .q-item-a { font-size: 14px; color: #00ff66; margin-bottom: 3px; }
        .q-item-o { font-size: 12px; color: #aaa; }
        .q-item-lvl { display: inline-block; background: #333; padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #fff; margin-top: 5px; }

        /* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; padding: 25px; border-radius: 10px; width: 90%; max-width: 800px; border: 2px solid var(--ui-color); max-height: 90vh; overflow-y: auto; }
        .preset-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px; }
        .preset-img { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .preset-img:hover { border-color: var(--ui-color); transform: scale(1.05); }

        /* –≠–ö–°–ü–û–†–¢ */
        #export-code { width: 100%; height: 150px; background: #000; color: #00ff66; font-family: monospace; border: 1px solid #555; padding: 15px; box-sizing: border-box; font-size: 14px; margin-bottom: 20px; border-radius: 8px; }
    </style>
</head>
<body>

<div id="editor-ui">
    <header>
        <div class="logo-container">
            <img src="https://img.genially.com/67961b32a116fb001568a75e/aa411ed1-1aef-4f00-a1a6-59b64d18dc7a.png">
            <h1>MAZE TRAP BUILDER 4.3 (All-in-One Edition)</h1>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('tab-design', this)">1. –î–ò–ó–ê–ô–ù –ò –ù–ê–°–¢–†–û–ô–ö–ò</button>
        <button class="tab-btn" onclick="openTab('tab-levels', this)">2. –£–†–û–í–ù–ò</button>
        <button class="tab-btn" onclick="openTab('tab-questions', this)">3. –í–û–ü–†–û–°–´</button>
        <button class="tab-btn" onclick="openTab('tab-preview', this)">4. –ü–†–ï–î–ü–†–û–°–ú–û–¢–†</button>
        <button class="tab-btn" onclick="openTab('tab-export', this)" style="color:#39ff14;">5. –≠–ö–°–ü–û–†–¢</button>
    </div>

    <main>
        <div id="tab-design" class="tab-content active">
            <div class="grid-2">
                <div class="form-group">
                    <label>–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:</label>
                    <select id="cfg-lang">
                        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                        <option value="en">English</option>
                        <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                        <option value="de">Deutsch (–ù–µ–º–µ—Ü–∫–∏–π)</option>
                        <option value="fr">Fran√ßais (–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π)</option>
                        <option value="kk">–ö–∞–∑–∞—Ö—Å–∫–∏–π</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–í—Ä–µ–º—è –Ω–∞ —É—Ä–æ–≤–µ–Ω—å (—Å–µ–∫):</label>
                    <input type="number" id="cfg-time" value="120">
                </div>
            </div>

            <div class="form-group">
                <label>–¶–≤–µ—Ç–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏ —à—Ä–∏—Ñ—Ç—ã:</label>
                <div class="grid-4">
                    <div class="color-picker-group">
                        <span style="font-size:12px; color:#aaa;">–ù–µ–æ–Ω (UI)</span>
                        <input type="color" id="cfg-ui-color" value="#39ff14" oninput="syncColor(this, 'txt-ui-color'); updatePreview()">
                        <input type="text" id="txt-ui-color" value="#39ff14" oninput="document.getElementById('cfg-ui-color').value=this.value; updatePreview()">
                    </div>
                    <div class="color-picker-group">
                        <span style="font-size:12px; color:#aaa;">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                        <input type="color" id="cfg-prog-color" value="#00ff66" oninput="syncColor(this, 'txt-prog-color')">
                        <input type="text" id="txt-prog-color" value="#00ff66" oninput="document.getElementById('cfg-prog-color').value=this.value">
                    </div>
                    <div class="color-picker-group">
                        <span style="font-size:12px; color:#aaa;">–í–æ–ø—Ä–æ—Å</span>
                        <input type="color" id="cfg-q-color" value="#ffe600" oninput="syncColor(this, 'txt-q-color'); updatePreview()">
                        <input type="text" id="txt-q-color" value="#ffe600" oninput="document.getElementById('cfg-q-color').value=this.value; updatePreview()">
                    </div>
                    <div class="color-picker-group">
                        <span style="font-size:12px; color:#aaa;">–û—Ç–≤–µ—Ç (–¢–µ–∫—Å—Ç)</span>
                        <input type="color" id="cfg-a-color" value="#ffffff" oninput="syncColor(this, 'txt-a-color'); updatePreview()">
                        <input type="text" id="txt-a-color" value="#ffffff" oninput="document.getElementById('cfg-a-color').value=this.value; updatePreview()">
                    </div>
                    <div class="color-picker-group" style="grid-column: span 2;">
                        <span style="font-size:12px; color:#aaa;">–û—Ç–≤–µ—Ç (–§–æ–Ω –∫–Ω–æ–ø–æ–∫ Hex)</span>
                        <input type="color" id="cfg-a-bg" value="#333333" oninput="syncColor(this, 'txt-a-bg'); updatePreview()">
                        <input type="text" id="txt-a-bg" value="#333333" oninput="document.getElementById('cfg-a-bg').value=this.value; updatePreview()">
                    </div>
                </div>
            </div>

            <div class="grid-2">
                <div class="form-group">
                    <label>–®—Ä–∏—Ñ—Ç –∏–≥—Ä—ã:</label>
                    <select id="cfg-font" onchange="updatePreview()">
                        <option value="'Metamorphous', serif">Metamorphous</option>
                        <option value="'Orbitron', sans-serif">Orbitron</option>
                        <option value="'Caveat', cursive">Caveat</option>
                        <option value="'Cinzel', serif">Cinzel</option>
                        <option value="'Macondo', cursive">Macondo</option>
                        <option value="'Montserrat', sans-serif">Montserrat</option>
                        <option value="'Comic Neue', cursive">Comic Neue</option>
                        <option value="'Pacifico', cursive">Pacifico</option>
                    </select>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>–†–∞–∑–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞:</label>
                        <input type="number" id="cfg-q-size" value="28" onchange="updatePreview()">
                    </div>
                    <div class="form-group">
                        <label>–†–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:</label>
                        <input type="number" id="cfg-a-size" value="22" onchange="updatePreview()">
                    </div>
                </div>
            </div>

            <div class="grid-2">
                <div class="form-group"><label>–°–ø—Ä–∞–π—Ç –ò–≥—Ä–æ–∫–∞ (–ü—É—à–∫–∞):</label><input type="text" id="cfg-img-shooter" value="https://img.genially.com/67961b32a116fb001568a75e/ff229730-a24f-4a1b-8050-c77cb309e646.png"></div>
                <div class="form-group"><label>–°–ø—Ä–∞–π—Ç –ú–∞—Å–∫–∏ (–§–∏–Ω–∏—à):</label><input type="text" id="cfg-img-mask" value="https://img.genially.com/67961b32a116fb001568a75e/4db0de92-1c31-4b38-8c29-df8dc6712266.png" onchange="updatePreview()"></div>
                <div class="form-group"><label>–°–ø—Ä–∞–π—Ç –ñ–∏–∑–Ω–∏ (–°–µ—Ä–¥—Ü–µ):</label><input type="text" id="cfg-img-heart" value="https://img.genially.com/67961b32a116fb001568a75e/213dec47-3717-4811-a68b-20fe7262ec2d.png"></div>
                <div class="form-group"><label>–°–ø—Ä–∞–π—Ç –ß–∞—Å–æ–≤ (–¢–∞–π–º–µ—Ä):</label><input type="text" id="cfg-img-clock" value="https://img.genially.com/67961b32a116fb001568a75e/6aa141cb-f83b-4167-9de0-25eeff46e4e2.png"></div>
            </div>
        </div>

        <div id="tab-levels" class="tab-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Ä–æ–≤–Ω–µ–π</h2>
                <button class="btn-main" onclick="addLevel()">+ –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
            </div>
            <div id="levels-container"></div>
        </div>

        <div id="tab-questions" class="tab-content">
            <div class="grid-2">
                <div>
                    <h2>–ë–∞–∑–∞ –≤–æ–ø—Ä–æ—Å–æ–≤</h2>
                    <div id="questions-list" style="max-height: 500px; overflow-y: auto; padding-right: 10px;"></div>
                </div>
                
                <div class="form-group" style="position: sticky; top: 20px;">
                    <h3 style="margin-top:0; color:var(--ui-color);">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</h3>
                    <label>–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞:</label>
                    <select id="q-type" onchange="toggleQType()">
                        <option value="mcq">–í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç–∞ (–ö–Ω–æ–ø–∫–∏)</option>
                        <option value="order">–°–±–æ—Ä–∫–∞ —Ñ—Ä–∞–∑—ã –∏–∑ —Å–ª–æ–≤</option>
                        <option value="input">–†—É—á–Ω–æ–π –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞</option>
                    </select>

                    <label style="margin-top:10px;">–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
                    <textarea id="q-text" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å..."></textarea>

                    <div id="wrap-mcq">
                        <label style="margin-top:10px;">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</label>
                        <input type="text" id="q-mcq-a" placeholder="–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç">
                        <label style="margin-top:10px;">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (—á–µ—Ä–µ–∑ |):</label>
                        <input type="text" id="q-mcq-w" placeholder="–õ–æ–∂—å 1 | –õ–æ–∂—å 2 | –õ–æ–∂—å 3">
                    </div>

                    <div id="wrap-order" style="display:none;">
                        <label style="margin-top:10px;">–§—Ä–∞–∑–∞ (—Å–ª–æ–≤–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª):</label>
                        <input type="text" id="q-order-a" placeholder="I have a dog">
                    </div>

                    <div id="wrap-input" style="display:none;">
                        <label style="margin-top:10px;">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ |):</label>
                        <input type="text" id="q-input-a" placeholder="dog | a dog">
                    </div>

                    <label style="margin-top:10px;">–£—Ä–æ–≤–µ–Ω—å:</label>
                    <select id="q-lvl"><option value="all">–î–ª—è –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π</option></select>

                    <button class="btn-main" style="width:100%; margin-top:20px;" onclick="saveQuestion()">+ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
                </div>
            </div>
        </div>

        <div id="tab-preview" class="tab-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
                <h2>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —ç–∫—Ä–∞–Ω–∞ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã</h2>
                <div>
                    <select id="preview-bg-sel" onchange="changePreviewBg()" style="width:200px; display:inline-block; margin-right:10px;">
                        </select>
                    <button class="btn-main" onclick="togglePreviewMode()">–í–∫–ª/–í—ã–∫–ª –ü–ª–∞—à–∫—É</button>
                </div>
            </div>
            <div class="preview-box" id="p-box">
                <div class="preview-overlay" id="p-overlay">
                    <div class="preview-card" id="p-card">
                        <img id="p-mask" src="" style="width:90px; margin-bottom:15px;">
                        <div id="p-q">What is the capital of Great Britain?</div>
                        <div class="ans-btn-preview" id="p-btn1">London</div>
                        <div class="ans-btn-preview" id="p-btn2">Paris</div>
                        <div class="ans-btn-preview" id="p-btn3">New York</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-export" class="tab-content">
            <h2>–ì–æ—Ç–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è Genially</h2>
            <p>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –µ—ë –≤ Genially (–í—Å—Ç–∞–≤–∏—Ç—å -> –î—Ä—É–≥–∏–µ -> –í—Å—Ç–∞–≤–∏—Ç—å –≤–Ω–µ—à–Ω—é—é —Å—Å—ã–ª–∫—É).</p>
            <textarea id="export-code" readonly></textarea>
            <button class="btn-main" style="background:var(--ui-color); color:#000; width:100%; font-size:18px;" onclick="copyToClipboard()">üìã –°–ö–û–ü–ò–†–û–í–ê–¢–¨ –°–°–´–õ–ö–£</button>
            <button class="btn-main" style="width:100%; margin-top:15px;" onclick="generateGeniallyLink()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Å—ã–ª–∫—É (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ)</button>
        </div>
    </main>

    <div id="bg-modal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--ui-color); margin-top:0;">–í—ã–±—Ä–∞—Ç—å —Ñ–æ–Ω</h2>
            <div class="preset-grid" id="bg-presets"></div>
            <button class="btn-main" style="margin-top:20px; width:100%;" onclick="closeModal('bg-modal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<div id="game-ui">
    <div style="color:#fff; text-align:center; padding-top:20vh; font-family:sans-serif;">
        <h1>–ò–ì–†–ê –ó–ê–ì–†–£–ñ–ê–ï–¢–°–Ø...</h1>
        <p>–ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç, –∑–Ω–∞—á–∏—Ç –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ!<br>–î–≤–∏–∂–æ–∫ –∏–≥—Ä—ã –º—ã –≤—Å—Ç–∞–≤–∏–º —Å—é–¥–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ.</p>
    </div>
</div>

<script>
// ==========================================
// –õ–û–ì–ò–ö–ê –ú–ê–†–®–†–£–¢–ò–ó–ê–¶–ò–ò
// ==========================================
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.has('data')) {
    document.body.classList.add('mode-game');
    // initGameEngine(JSON.parse(decodeURIComponent(escape(atob(urlParams.get('data'))))));
} else {
    document.body.classList.add('mode-editor');
}

// ==========================================
// –õ–û–ì–ò–ö–ê –†–ï–î–ê–ö–¢–û–†–ê
// ==========================================
const PRESETS = [
    "https://img.genially.com/67961b32a116fb001568a75e/ccde12e3-391b-41b3-9e20-803cfa4b5506.png",
    "https://img.genially.com/67961b32a116fb001568a75e/d197607a-d0b1-41b8-89bd-a0b22a578351.png",
    "https://img.genially.com/67961b32a116fb001568a75e/74f83966-2d33-40ea-a0d0-fb97f76634c0.png",
    "https://img.genially.com/67961b32a116fb001568a75e/0a58da81-2dd3-4b68-8de9-b22de7ff3cd2.png",
    "https://img.genially.com/67961b32a116fb001568a75e/7454c7d0-1017-4db9-8dce-03cc456b3e0b.png"
];

let levels = [];
let questionsDB = [];
let targetLvlInput = null;

function syncColor(src, targetId) { document.getElementById(targetId).value = src.value; }
function openTab(id, btn) {
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
    if(id==='tab-preview') updatePreview();
}

// –£—Ä–æ–≤–Ω–∏
function addLevel() {
    levels.push({ bg: PRESETS[0], path: "[]", qCount: 5 });
    renderLevels(); updateQLevelSelect(); updatePreviewBgSelect();
}
function removeLevel(idx) { levels.splice(idx,1); renderLevels(); updateQLevelSelect(); updatePreviewBgSelect(); }

function renderLevels() {
    const cont = document.getElementById('levels-container');
    cont.innerHTML = '';
    levels.forEach((l, i) => {
        let bgStyle = l.bg.startsWith('http') ? `background-image: url('${l.bg}');` : `background-color: #333;`;
        cont.innerHTML += `
        <div class="form-group" style="position:relative;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:var(--ui-color);">–£–†–û–í–ï–ù–¨ ${i+1}</h3>
                <button class="btn-del" onclick="removeLevel(${i})">‚úñ –£–¥–∞–ª–∏—Ç—å</button>
            </div>
            <div class="grid-2">
                <div>
                    <label>–§–æ–Ω (–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ):</label>
                    <div style="display:flex; gap:10px;">
                        <div style="width:60px; height:40px; border-radius:5px; border:1px solid #555; background-size:cover; background-position:center; ${bgStyle}"></div>
                        <input type="text" id="lvl-bg-${i}" value="${l.bg}" onchange="levels[${i}].bg=this.value; renderLevels(); updatePreviewBgSelect();">
                        <button class="btn-main" style="padding:10px;" onclick="openBgModal('lvl-bg-${i}', ${i})">–í—ã–±—Ä–∞—Ç—å</button>
                    </div>
                    <label style="margin-top:15px;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤:</label>
                    <input type="number" value="${l.qCount}" onchange="levels[${i}].qCount=parseInt(this.value)">
                </div>
                <div>
                    <label>–ö–æ–¥ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ (Path):</label>
                    <textarea onchange="levels[${i}].path=this.value">${l.path}</textarea>
                    <div style="text-align:right; margin-top:5px;">
                        <a href="https://gemini-ai-collaborator.github.io/path-generator/generator.html" target="_blank" style="color:var(--ui-color); font-size:12px;">–£–¥–æ–±–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–π -></a>
                    </div>
                </div>
            </div>
        </div>`;
    });
}

// –ú–æ–¥–∞–ª–∫–∞ —Ñ–æ–Ω–æ–≤
function openBgModal(targetId, index) {
    targetLvlInput = { id: targetId, idx: index };
    const grid = document.getElementById('bg-presets');
    grid.innerHTML = '';
    PRESETS.forEach(url => {
        const img = document.createElement('img');
        img.src = url; img.className = 'preset-img';
        img.onclick = () => {
            document.getElementById(targetLvlInput.id).value = url;
            levels[targetLvlInput.idx].bg = url;
            closeModal('bg-modal');
            renderLevels(); updatePreviewBgSelect();
        };
        grid.appendChild(img);
    });
    document.getElementById('bg-modal').style.display = 'flex';
}
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

// –í–æ–ø—Ä–æ—Å—ã
function toggleQType() {
    const t = document.getElementById('q-type').value;
    document.getElementById('wrap-mcq').style.display = t==='mcq' ? 'block' : 'none';
    document.getElementById('wrap-order').style.display = t==='order' ? 'block' : 'none';
    document.getElementById('wrap-input').style.display = t==='input' ? 'block' : 'none';
}
function updateQLevelSelect() {
    const sel = document.getElementById('q-lvl');
    sel.innerHTML = '<option value="all">–î–ª—è –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π</option>';
    levels.forEach((_, i) => sel.innerHTML += `<option value="${i}">–¢–æ–ª—å–∫–æ –£—Ä–æ–≤–µ–Ω—å ${i+1}</option>`);
}
function saveQuestion() {
    const type = document.getElementById('q-type').value;
    const qText = document.getElementById('q-text').value.trim();
    if(!qText) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞!");
    let qObj = { type: type, q: qText, lvl: document.getElementById('q-lvl').value };

    if(type === 'mcq') {
        const a = document.getElementById('q-mcq-a').value.trim();
        const w = document.getElementById('q-mcq-w').value.split('|').map(s=>s.trim()).filter(s=>s!=="");
        if(!a) return alert("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç!");
        qObj.a = a; qObj.o = [a, ...w].sort(()=>Math.random()-0.5);
    } else if(type === 'order') {
        const a = document.getElementById('q-order-a').value.trim();
        if(!a) return alert("–í–≤–µ–¥–∏—Ç–µ —Ñ—Ä–∞–∑—É!");
        qObj.a = a; qObj.words = a.split(' ').map(s=>s.trim()).filter(s=>s!=="");
    } else if(type === 'input') {
        const a = document.getElementById('q-input-a').value.trim();
        if(!a) return alert("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç!");
        qObj.a = a;
    }
    questionsDB.push(qObj);
    
    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById('q-text').value = '';
    document.getElementById('q-mcq-a').value = ''; document.getElementById('q-mcq-w').value = '';
    document.getElementById('q-order-a').value = ''; document.getElementById('q-input-a').value = '';
    renderQuestions();
}

function removeQuestion(idx) { questionsDB.splice(idx,1); renderQuestions(); }
function renderQuestions() {
    const cont = document.getElementById('questions-list');
    cont.innerHTML = '';
    if(questionsDB.length === 0) cont.innerHTML = '<p style="color:#666;">–ü–æ–∫–∞ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤.</p>';
    questionsDB.forEach((q, i) => {
        let details = '';
        if(q.type === 'mcq') details = `<div class="q-item-a">–û—Ç–≤–µ—Ç: ${q.a}</div><div class="q-item-o">–í–∞—Ä–∏–∞–Ω—Ç—ã: ${q.o.join(', ')}</div>`;
        else if(q.type === 'order') details = `<div class="q-item-a">–°–æ–±—Ä–∞—Ç—å —Ñ—Ä–∞–∑—É: ${q.a}</div>`;
        else if(q.type === 'input') details = `<div class="q-item-a">–ü—Ä–∏–Ω–∏–º–∞–µ–º—ã–µ –æ—Ç–≤–µ—Ç—ã: ${q.a}</div>`;
        
        let lvlText = q.lvl === 'all' ? '–í—Å–µ —É—Ä–æ–≤–Ω–∏' : `–£—Ä–æ–≤–µ–Ω—å ${parseInt(q.lvl)+1}`;
        cont.innerHTML += `
        <div class="q-item">
            <div class="q-item-content">
                <div class="q-item-type">–¢–∏–ø: ${q.type}</div>
                <div class="q-item-q">${q.q}</div>
                ${details}
                <div class="q-item-lvl">${lvlText}</div>
            </div>
            <button class="btn-del" style="margin-left:15px;" onclick="removeQuestion(${i})">‚úñ</button>
        </div>`;
    });
}

// –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
function updatePreviewBgSelect() {
    const sel = document.getElementById('preview-bg-sel');
    sel.innerHTML = '<option value="">–ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω</option>';
    levels.forEach((l, i) => sel.innerHTML += `<option value="${l.bg}">–§–æ–Ω —É—Ä–æ–≤–Ω—è ${i+1}</option>`);
    changePreviewBg();
}
function changePreviewBg() {
    const bg = document.getElementById('preview-bg-sel').value;
    document.getElementById('p-box').style.backgroundImage = bg ? `url('${bg}')` : 'none';
}
function togglePreviewMode() {
    document.getElementById('p-overlay').classList.toggle('hidden');
}
function updatePreview() {
    const root = document.documentElement;
    const uiC = document.getElementById('cfg-ui-color').value;
    const qC = document.getElementById('cfg-q-color').value;
    const aC = document.getElementById('cfg-a-color').value;
    
    root.style.setProperty('--ui-color', uiC);
    root.style.setProperty('--q-color', qC);
    root.style.setProperty('--a-color', aC);
    root.style.setProperty('--q-size', document.getElementById('cfg-q-size').value + 'px');
    root.style.setProperty('--a-size', document.getElementById('cfg-a-size').value + 'px');
    root.style.setProperty('--game-font', document.getElementById('cfg-font').value);
    
    let hex = document.getElementById('cfg-a-bg').value; 
    let r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
    root.style.setProperty('--a-bg', `rgba(${r},${g},${b}, 0.6)`);

    document.getElementById('p-mask').src = document.getElementById('cfg-img-mask').value;
}

// –≠–ö–°–ü–û–†–¢ (–ì–ï–ù–ï–†–ê–¶–ò–Ø –°–°–´–õ–ö–ò)
function generateGeniallyLink() {
    // –û—á–∏—â–∞–µ–º —É—Ä–æ–≤–Ω–∏ –ø–µ—Ä–µ–¥ —ç–∫—Å–ø–æ—Ä—Ç–æ–º
    let cleanLevels = levels.map(l => {
        let parsedPath = [];
        try { parsedPath = JSON.parse(l.path || '[]'); } catch(e){}
        return { bg: l.bg.startsWith('url') ? l.bg : `url('${l.bg}')`, path: parsedPath, qCount: l.qCount };
    });

    const config = {
        lang: document.getElementById('cfg-lang').value,
        timerStart: parseInt(document.getElementById('cfg-time').value) || 120,
        fontFamily: document.getElementById('cfg-font').value,
        uiColor: document.getElementById('cfg-ui-color').value,
        progColor: document.getElementById('cfg-prog-color').value,
        qColor: document.getElementById('cfg-q-color').value,
        qSize: document.getElementById('cfg-q-size').value + "px",
        aColor: document.getElementById('cfg-a-color').value,
        aSize: document.getElementById('cfg-a-size').value + "px",
        aBgHex: document.getElementById('cfg-a-bg').value,
        imgShooter: document.getElementById('cfg-img-shooter').value,
        imgMask: document.getElementById('cfg-img-mask').value,
        imgHeart: document.getElementById('cfg-img-heart').value,
        imgClock: document.getElementById('cfg-img-clock').value,
        levels: cleanLevels,
        questions: questionsDB
    };

    // –°–æ–∑–¥–∞–µ–º Base64 —Å—Å—ã–ª–∫—É
    const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(config))));
    const baseUrl = window.location.href.split('?')[0];
    const finalUrl = `${baseUrl}?data=${encoded}`;

    document.getElementById('export-code').value = finalUrl;
}

function copyToClipboard() {
    let copyText = document.getElementById("export-code");
    copyText.select(); document.execCommand("copy");
    alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –í—Å—Ç–∞–≤—å—Ç–µ –µ—ë –≤ Genially.");
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
addLevel();
</script>
</body>
</html>
